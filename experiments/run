#!/bin/bash

# Script for one-off testing of benchmark

getopt --test > /dev/null
if [[ $? -ne 4 ]]; then
  echo "Sorry, we require enhanced getopt"
  exit 1
fi

PARSED=$(getopt --options 'f,q' --longoptions 'fast,quiet,noisy' --name "$0" -- "$@")
if [[ $? -ne 0 ]]; then
  exit 2
fi

eval set -- "$PARSED"

fast=0
quiet=1
while true; do
  case "$1" in
    -f|--fast)
      fast=1
      shift
      ;;
    -q|--quiet)
      quiet=1
      shift
      ;;
    --noisy)
      quiet=0
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "assert false"
      exit 3
  esac
done

if [[ $# -ne 1 ]]; then
  echo "usage: $0 [OPTIONS] file.lua"
fi

script="$1"

name=$(basename "$script")
name=${name%.lua}

if [[ $fast -eq 1 ]]; then
  opts="-l $name"
else
  opts=""
fi

run_possibly_quiet() {
  if [[ "$quiet" -eq 1 ]]; then
    "$@" > /dev/null
  else
    "$@"
  fi
}


export LUA_CPATH_5_3="./generated/?.so;;"
run_possibly_quiet time --format 'time=%Us system=%S elapsed=%E' ../src/lua $opts "$script"


